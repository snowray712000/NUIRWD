import { tap, retry, } from 'rxjs/operators';
import { Observable, of } from 'rxjs';
import { ajax } from 'rxjs/ajax';
import { FhlUrl } from '../FhlUrl';
import { DAbvResult } from './DAbvResult';
import { IsLocalHostDevelopment } from '../IsLocalHostDevelopment';
import { DisplayLangSetting } from 'src/app/rwd-frameset/dialog-display-setting/DisplayLangSetting';

/** 不要使用這個, 使用 VerCache */
class ApiAbv {
  private static cache: DAbvResult;
  private static cacheGb: DAbvResult;

  constructor() { }
  public queryAbvPhpOrCache(isGb = false): Observable<DAbvResult> {
    if (false == isGb && ApiAbv.cache != undefined ){
      return of(ApiAbv.cache)
    }
    if( isGb && ApiAbv.cacheGb != undefined ){
      return of(ApiAbv.cacheGb)
    }

    // const url = 'http://bkbible.fhl.net/json/abv.php';
    const url = `${new FhlUrl().getJsonUrl2()}uiabv.php?gb=${isGb?'1':'0'}`;
    return ajax.getJSON<DAbvResult>(url, {
      'Access-Control-Allow-Origin' : '*',
      'Access-Control-Allow-Methods':'GET, POST',
      'Access-Control-Max-Age': '86400'
    }).pipe(retry(3),tap(a1=>{
      if (isGb) {
        ApiAbv.cacheGb = a1 
      } else {
        ApiAbv.cache = a1
      }
    }))
    
    return ajax.getJSON<DAbvResult>(url).pipe(
      retry(3),
      // tap(a1 => console.log(a1)),
      tap(a1 => {
        if (isGb) {
          ApiAbv.cacheGb = a1 
        } else {
          ApiAbv.cache = a1
        }
      }),
      // tap(a1 => console.log(a1)),
    );
  }
}

export async function ApiAbv_getRecordsFromApiAsync(): Promise<DAbvResult> {
  let abvResult = getTestAbvData() // 因 CROS 限制，開發要用此
  if (false == IsLocalHostDevelopment.isLocalHost) {
      const isGb = DisplayLangSetting.s.getFromLocalStorageIsGB()
      abvResult = (await new ApiAbv().queryAbvPhpOrCache(isGb).toPromise())!
  } 

  return abvResult

  function getTestAbvData() {
    return new ApiAbvHardCode().main()
  }
}

/**
 * 這個是手動將 uiabv.php 網頁，透過網頁工具直接 copy 回應字串。因為 CROS ，這樣才方便開發
 * 最後更新是 2023.8 月
 */
class ApiAbvHardCode {
  public main(): DAbvResult {
    return JSON.parse(getText()) as DAbvResult

    function getText(){
      return `{
        "status":"success",
        "parsing":"",
        "comment":"",
        "record_count":82,
        "record":[{"book":"unv",
        "cname":"\u548c\u5408\u672c",
        "proc":0,
        "strong":1,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"ncv",
        "cname":"\u65b0\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"tcv95",
        "cname":"\u73fe\u4ee3\u4e2d\u6587\u8b6f\u672c1995\u7248",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"tcv2019",
        "cname":"\u73fe\u4ee3\u4e2d\u6587\u8b6f\u672c2019\u7248",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"recover",
        "cname":"\u6062\u5fa9\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"csb",
        "cname":"\u4e2d\u6587\u6a19\u6e96\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"rcuv",
        "cname":"\u548c\u5408\u672c2010",
        "proc":0,
        "strong":1,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"lcc",
        "cname":"\u5442\u632f\u4e2d\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"ofm",
        "cname":"\u601d\u9ad8\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"wlunv",
        "cname":"\u6df1\u6587\u7406\u548c\u5408\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"cnet",
        "cname":"NET\u8056\u7d93\u4e2d\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cccbst",
        "cname":"\u8056\u7d93\u516c\u6703\u56db\u798f\u97f3\u66f8\u5171\u540c\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"nt1864",
        "cname":"\u65b0\u907a\u8a54\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"cbol",
        "cname":"\u539f\u6587\u76f4\u8b6f(\u53c3\u8003\u7528)",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"esv",
        "cname":"ESV",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"kjv",
        "cname":"KJV",
        "proc":0,
        "strong":1,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"bbe",
        "cname":"BBE",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"web",
        "cname":"WEB",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"asv",
        "cname":"ASV",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"darby",
        "cname":"Darby",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"erv",
        "cname":"ERV",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"bhs",
        "cname":"\u820a\u7d04\u99ac\u7d22\u62c9\u539f\u6587",
        "proc":2,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":1,
        "version":""},
        {"book":"fhlwh",
        "cname":"\u65b0\u7d04\u539f\u6587",
        "proc":1,
        "strong":0,
        "ntonly":1,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"lxx",
        "cname":"\u4e03\u5341\u58eb\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":1,
        "version":""},
        {"book":"ttvhl2021",
        "cname":"\u73fe\u4ee3\u53f0\u8a9e2021\u7248\u6f22\u5b57",
        "proc":4,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"ttvcl2021",
        "cname":"\u73fe\u4ee3\u53f0\u8a9e2021\u7248\u5168\u7f85",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"tte",
        "cname":"\u73fe\u4ee3\u53f0\u8a9e2013\u7248\u5168\u7f85",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"ttvh",
        "cname":"\u73fe\u4ee3\u53f0\u8a9e2013\u7248\u6f22\u5b57",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"apskcl",
        "cname":"\u7d05\u76ae\u8056\u7d93\u5168\u7f85",
        "proc":3,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"apskhl",
        "cname":"\u7d05\u76ae\u8056\u7d93\u6f22\u7f85",
        "proc":3,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"bklcl",
        "cname":"\u5df4\u514b\u79ae\u5168\u7f85",
        "proc":3,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"tghg",
        "cname":"\u8056\u7d93\u516c\u6703\u5df4\u514b\u79ae\u53f0\u6f22\u672c",
        "proc":4,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"bklhl",
        "cname":"\u5df4\u514b\u79ae\u6f22\u7f85",
        "proc":3,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"prebklcl",
        "cname":"\u99ac\u96c5\u5404\u5168\u7f85",
        "proc":3,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"thv2e",
        "cname":"\u8056\u7d93\u516c\u6703\u73fe\u4ee3\u5ba2\u8a9e\u5168\u7f85",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"thv12h",
        "cname":"\u8056\u7d93\u516c\u6703\u73fe\u4ee3\u5ba2\u8a9e\u6f22\u5b57",
        "proc":4,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"hakka",
        "cname":"\u6c55\u982d\u5ba2\u8a9e\u8056\u7d93",
        "proc":3,
        "strong":0,
        "ntonly":1,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"sgebklcl",
        "cname":"\u5168\u6c11\u53f0\u8a9e\u8056\u7d93\u5168\u7f85",
        "proc":3,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"sgebklhl",
        "cname":"\u5168\u6c11\u53f0\u8a9e\u8056\u7d93\u6f22\u7f85",
        "proc":3,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"vietnamese",
        "cname":"\u8d8a\u5357\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"russian",
        "cname":"\u4fc4\u6587\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"korean",
        "cname":"\u97d3\u6587\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"jp",
        "cname":"\u65e5\u8a9e\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"rukai",
        "cname":"\u8056\u7d93\u516c\u6703\u9b6f\u51f1\u8a9e\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"tay",
        "cname":"\u8056\u7d93\u516c\u6703\u6cf0\u96c5\u723e\u8a9e\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"tsou",
        "cname":"\u8056\u7d93\u516c\u6703\u9112\u8a9e\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"ams",
        "cname":"\u8056\u7d93\u516c\u6703\u963f\u7f8e\u8a9e1997",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"amis2",
        "cname":"\u8056\u7d93\u516c\u6703\u963f\u7f8e\u8a9e2019",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"sed",
        "cname":"\u8cfd\u5fb7\u514b\u8a9e",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"ttnt94",
        "cname":"\u8056\u7d93\u516c\u6703\u9054\u609f\u8a9e\u65b0\u7d04\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"tibet",
        "cname":"\u85cf\u8a9e\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"cvul",
        "cname":"\u6b66\u52a0\u5927\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"nvul",
        "cname":"\u65b0\u6b66\u52a0\u5927\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cumv",
        "cname":"\u5b98\u8a71\u548c\u5408\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"pmb",
        "cname":"\u5317\u4eac\u5b98\u8a71\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"cuwv",
        "cname":"\u6587\u7406\u548c\u5408\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cuwve",
        "cname":"\u6dfa\u6587\u7406\u548c\u5408\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwang",
        "cname":"\u738b\u5143\u5fb7\u5b98\u8a71\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"orthdox",
        "cname":"\u4fc4\u7f85\u65af\u6b63\u6559\u6587\u7406\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"basset",
        "cname":"\u767d\u65e5\u6607\u5f90\u7d04\u7ff0\u6587\u7406\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"mormil",
        "cname":"\u795e\u5929\u8056\u66f8",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"wdv",
        "cname":"\u6587\u7406\u59d4\u8fa6\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"ssewb",
        "cname":"\u65bd\u7d04\u745f\u6dfa\u6587\u7406\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":1,
        "otonly":0,
        "version":""},
        {"book":"marwb",
        "cname":"\u99ac\u6b8a\u66fc\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"goddwb",
        "cname":"\u9ad8\u5fb7\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"hudsonwb",
        "cname":"\u80e1\u5fb7\u9081\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"deanwb",
        "cname":"\u7ca6\u70ba\u4ec1\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cmxuhsb",
        "cname":"\u5f90\u532f\u5b98\u8a71\u65b0\u8b6f\u798f\u97f3",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwangdmm",
        "cname":"\u738b\u591a\u9ed8\u8056\u53f2\u5b97\u5f92\u884c\u5be6",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwhsiaosb",
        "cname":"\u856d\u821c\u83ef\u5b98\u8a71",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwmgbm",
        "cname":"\u56db\u4eba\u5c0f\u7d44\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwfaubsb",
        "cname":"\u8056\u4fdd\u797f\u66f8\u7ff0\u4e26\u6578\u4f4d\u5b97\u5f92\u6db5\u7258",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwjdsb",
        "cname":"\u5fb7\u5982\u745f\u56db\u53f2\u8056\u7d93\u8b6f\u8a3b",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwkfag",
        "cname":"\u90ed\u5be6\u81d8\u65b0\u907a\u8a54\u66f8\u548c\u820a\u907a\u8a54\u8056\u66f8",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwliwysb",
        "cname":"\u5b97\u5f92\u5927\u4e8b\u9304\u548c\u65b0\u7d93\u8b6f\u7fa9",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwmxb",
        "cname":"\u99ac\u76f8\u4f2f\u6551\u4e16\u798f\u97f3",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwont",
        "cname":"\u4fc4\u7f85\u65af\u6b63\u6559\u65b0\u907a\u8a54\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwplbsb",
        "cname":"\u535c\u58eb\u5091\u65b0\u7d93\u516c\u51fd\u8207\u9ed8\u793a\u9304",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cwtaiping",
        "cname":"\u592a\u5e73\u5929\u570b\u6587\u7406\u8b6f\u672c",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cxubinwsb",
        "cname":"\u8a31\u5f6c\u6587\u56db\u53f2\u5168\u7de8",
        "proc":0,
        "strong":0,
        "ntonly":1,
        "candownload":0,
        "otonly":0,
        "version":""},
        {"book":"cogorw",
        "cname":"\u9ad8\u9023\u8328\u57fa\u8056\u8a60\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":1,
        "version":""},
        {"book":"tru",
        "cname":"\u8056\u7d93\u516c\u6703\u592a\u9b6f\u95a3\u8a9e\u8056\u7d93",
        "proc":0,
        "strong":0,
        "ntonly":0,
        "candownload":0,
        "otonly":0,
        "version":""}
        ]}`
    }
  }
}